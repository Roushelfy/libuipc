# LibUIPC Installation Test - CentOS/RHEL
FROM nvidia/cuda:12.4-devel-centos7

# Install EPEL repository
RUN yum install -y epel-release

# Install system dependencies
RUN yum update -y && yum install -y \
    git \
    wget \
    curl \
    gcc \
    gcc-c++ \
    make \
    pkgconfig \
    tar \
    unzip \
    zip \
    python3 \
    python3-pip \
    python3-devel \
    && yum clean all

# Install modern CMake
RUN cd /tmp && \
    wget https://github.com/Kitware/CMake/releases/download/v3.27.0/cmake-3.27.0-linux-x86_64.tar.gz && \
    tar xzf cmake-3.27.0-linux-x86_64.tar.gz && \
    mv cmake-3.27.0-linux-x86_64 /opt/cmake && \
    ln -sf /opt/cmake/bin/cmake /usr/local/bin/cmake && \
    rm -f cmake-3.27.0-linux-x86_64.tar.gz

# Install Miniconda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh && \
    bash miniconda.sh -b -p /opt/conda && \
    rm miniconda.sh
ENV PATH="/opt/conda/bin:$PATH"

# Accept conda terms of service
RUN conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

# Create working directory
WORKDIR /workspace

# Copy installation scripts
COPY auto_install.py .
COPY install.sh .
COPY setup_pip.py .

# Make install script executable
RUN chmod +x install.sh

# Set up test environment
COPY test/test_installation.py .

# Default command
CMD ["/bin/bash"]